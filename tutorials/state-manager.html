<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>StateManager Tutorial | soundworks</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Full-stack JavaScript framework for distributed WebAudio and multimedia applications">
    
    <link rel="preload" href="/assets/css/0.styles.b69b988d.css" as="style"><link rel="preload" href="/assets/js/app.03c7ac74.js" as="script"><link rel="preload" href="/assets/js/2.295789f1.js" as="script"><link rel="preload" href="/assets/js/3.020169b2.js" as="script"><link rel="preload" href="/assets/js/19.23b6d228.js" as="script"><link rel="prefetch" href="/assets/js/10.3930ec7d.js"><link rel="prefetch" href="/assets/js/11.c9f2a169.js"><link rel="prefetch" href="/assets/js/12.ed4c9baa.js"><link rel="prefetch" href="/assets/js/13.a55b8609.js"><link rel="prefetch" href="/assets/js/14.67c3f31f.js"><link rel="prefetch" href="/assets/js/15.eb27f309.js"><link rel="prefetch" href="/assets/js/16.038de60a.js"><link rel="prefetch" href="/assets/js/17.3cde6390.js"><link rel="prefetch" href="/assets/js/18.12fd0794.js"><link rel="prefetch" href="/assets/js/4.08bcf3dc.js"><link rel="prefetch" href="/assets/js/5.43cbfcb5.js"><link rel="prefetch" href="/assets/js/6.8f95dfeb.js"><link rel="prefetch" href="/assets/js/7.838752c9.js"><link rel="prefetch" href="/assets/js/8.2ca6d1b6.js"><link rel="prefetch" href="/assets/js/9.7622735e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b69b988d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo-ismm-200x200.png" alt="soundworks" class="logo"> <span class="site-name can-hide">soundworks</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/getting-started.html" class="nav-link">
  Getting Started
</a></div><div class="nav-item"><a href="/ecosystem.html" class="nav-link">
  Ecosystem
</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link router-link-active">
  Tutorials
</a></div><div class="nav-item"><a href="/misc/" class="nav-link">
  Misc
</a></div><div class="nav-item"><a href="http://collective-soundworks.github.io/soundworks/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/collective-soundworks/collective-soundworks.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/getting-started.html" class="nav-link">
  Getting Started
</a></div><div class="nav-item"><a href="/ecosystem.html" class="nav-link">
  Ecosystem
</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link router-link-active">
  Tutorials
</a></div><div class="nav-item"><a href="/misc/" class="nav-link">
  Misc
</a></div><div class="nav-item"><a href="http://collective-soundworks.github.io/soundworks/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  API
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/collective-soundworks/collective-soundworks.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link"></a></li><li><a href="/introduction.html" class="sidebar-link">Introduction</a></li><li><a href="/getting-started.html" class="sidebar-link">Getting Started</a></li><li><a href="/ecosystem.html" class="sidebar-link">Ecosystem</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/tutorials/" class="sidebar-heading clickable router-link-active open"><span>Tutorials</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/tutorials/state-manager.html" aria-current="page" class="active sidebar-link">StateManager Tutorial</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tutorials/state-manager.html#table-of-content" class="sidebar-link">Table of Content</a></li><li class="sidebar-sub-header"><a href="/tutorials/state-manager.html#declaring-schemas" class="sidebar-link">Declaring Schemas</a></li><li class="sidebar-sub-header"><a href="/tutorials/state-manager.html#registering-schemas" class="sidebar-link">Registering Schemas</a></li><li class="sidebar-sub-header"><a href="/tutorials/state-manager.html#creating-states" class="sidebar-link">Creating States</a></li><li class="sidebar-sub-header"><a href="/tutorials/state-manager.html#attaching-to-states" class="sidebar-link">Attaching to States</a></li><li class="sidebar-sub-header"><a href="/tutorials/state-manager.html#observing-the-creation-of-states-on-the-network" class="sidebar-link">Observing the Creation of States on the Network</a></li><li class="sidebar-sub-header"><a href="/tutorials/state-manager.html#updating-values-and-subscribing-to-updates" class="sidebar-link">Updating Values and Subscribing to Updates</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/misc/" class="sidebar-heading clickable"><span>Misc</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="statemanager-tutorial"><a href="#statemanager-tutorial" class="header-anchor">#</a> StateManager Tutorial</h1> <blockquote><p>Learn how to use the soundworks' <code>stateManager</code> to:</p> <ul><li>create shared global and local states</li> <li>remote control and monitor clients of your application</li></ul> <p>Note that the <code>stateManager</code> component can simplifies the development of applications by abstracting in large parts network communications and routing.</p></blockquote> <h2 id="table-of-content"><a href="#table-of-content" class="header-anchor">#</a> Table of Content</h2> <p></p><div class="table-of-contents"><ul><li><a href="#table-of-content">Table of Content</a></li><li><a href="#declaring-schemas">Declaring Schemas</a></li><li><a href="#registering-schemas">Registering Schemas</a></li><li><a href="#creating-states">Creating States</a></li><li><a href="#attaching-to-states">Attaching to States</a></li><li><a href="#observing-the-creation-of-states-on-the-network">Observing the Creation of States on the Network</a></li><li><a href="#updating-values-and-subscribing-to-updates">Updating Values and Subscribing to Updates</a></li></ul></div><p></p> <div class="custom-block warning"><p class="custom-block-title">@todos</p> <ul><li>make a clean code example</li> <li>review end of tutorial</li></ul></div> <h2 id="declaring-schemas"><a href="#declaring-schemas" class="header-anchor">#</a> Declaring Schemas</h2> <p>The <code>stateManager</code> component makes use of schemas that declare a set of attributes and their properties (you can think of it has the schema of a database table). The schema syntax follows the format described in <a href="https://github.com/ircam-jstools/parameters" target="_blank" rel="noopener noreferrer">https://github.com/ircam-jstools/parameters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>In this application two schemas are declared (cf. <code>src/server/schemas/</code>, note that the <code>schema</code> directory is not mandatory but looks like a good practice to keep things clean).</p> <ul><li>the <code>globals</code> schema (cf. <code>src/server/schemas/globals.js</code>) is meant to declare a state that will be created by the server, and will thus be unique across the whole application. Every client will be able to attach to the created state, but we guarantee that this state will be kept identical across all of the clients.
Here, the schema declares a global <code>master</code> volume and a <code>mute</code> flag.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// `src/server/schemas/globals.js`</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// master volume in dB [-60, 6]</span>
  master<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span>
    min<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">60</span><span class="token punctuation">,</span>
    max<span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
    step<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// mute [true, false]</span>
  mute<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'boolean'</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>the <code>player</code> schema is dedicated to describing the state of a single player client, meaning that each player will instantiate its own instance of the schema. Other clients (typically a controller) can attach to the player's state to monitor and remotely control the client.
Here the schema declares two oscillator parameters: <code>type</code> and <code>frequency</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// `src/server/schemas/player.js`</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// dummy oscillator params</span>
  type<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'enum'</span><span class="token punctuation">,</span>
    list<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'sine'</span><span class="token punctuation">,</span> <span class="token string">'square'</span><span class="token punctuation">,</span> <span class="token string">'sawtooth'</span><span class="token punctuation">,</span> <span class="token string">'triangle'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'sine'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  frequency<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'integer'</span><span class="token punctuation">,</span>
    min<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
    max<span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">440</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="registering-schemas"><a href="#registering-schemas" class="header-anchor">#</a> Registering Schemas</h2> <ul><li><a href="http://collective-soundworks.github.io/soundworks/server.SharedStateManagerServer.html#registerSchema" target="_blank" rel="noopener noreferrer">server.SharedStateManagerServer#registerSchema<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Once the schemas have been declared, we must register them server-side into the soundworks' <code>stateManager</code>. Indeed, the server keeps a local instance of every state created in the application and acts as the only source of ground truth.</p> <p>A good practice is to do that after the server initialization (<code>await server.init(...)</code>, so that the state manager is ready to be used, but before the server start (<code>await server.start()</code>), so that we accept client connections when everything is properly configured.</p> <p>In order to register the schemas, you have to follow the two following steps:</p> <ol><li>import the files where the schemas are declared:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/server/index.js (line 15-16)</span>
<span class="token keyword">import</span> globalsSchema <span class="token keyword">from</span> <span class="token string">'./schemas/globals'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> playerSchema <span class="token keyword">from</span> <span class="token string">'./schemas/player'</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>register the schema to the <code>stateManager</code>:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/server/index.js (line 59-60)</span>
server<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">registerSchema</span><span class="token punctuation">(</span><span class="token string">'globals'</span><span class="token punctuation">,</span> globalsSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">registerSchema</span><span class="token punctuation">(</span><span class="token string">'player'</span><span class="token punctuation">,</span> playerSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="creating-states"><a href="#creating-states" class="header-anchor">#</a> Creating States</h2> <ul><li><a href="http://collective-soundworks.github.io/soundworks/server.SharedStateManagerServer.html#create" target="_blank" rel="noopener noreferrer">server.SharedStateManagerServer#create<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://collective-soundworks.github.io/soundworks/client.SharedStateManagerClient.html#create" target="_blank" rel="noopener noreferrer">client.SharedStateManagerClient#create<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Once schemas are registered, they can be instantiated by any server or clients <code>stateManager</code> (<em>note: internally the <code>server.stateManager</code> is itself a client of the shared state system, except for <code>registerState</code> method, its API is thus the same as the client side API</em>).</p> <p>Typically, creating a state server-side will allow to share a common state to all the clients of the application. While creating a state client side will create a novel instance of the state for every client, simplifying remote control and monitoring.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// or client-side</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">await</span> server<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>schemaName<span class="token punctuation">,</span> <span class="token punctuation">[</span>defaultValues<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// or client-side</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>schemaName<span class="token punctuation">,</span> <span class="token punctuation">[</span>defaultValues<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In the example application the <code>globals</code> state is created by the server:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/server/index.js (line 62)</span>
<span class="token keyword">const</span> globalsState <span class="token operator">=</span> <span class="token keyword">await</span> server<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'globals'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'globalsState:'</span><span class="token punctuation">,</span> globalsState<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &gt; globalsState: { master: 0, mute: false }</span>
</code></pre></div><p>While each player creates its own instance of the <code>player</code> schema:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/clients/player/PlayerExperience.js (line 22-24)</span>
<span class="token keyword">const</span> playerState <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">'player'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  frequency<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">950</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'playerState:'</span><span class="token punctuation">,</span> playerState<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &gt; playerState: {type: &quot;sine&quot;, frequency: 513}</span>
</code></pre></div><p>As we want every client connecting to play a different frequency, we initialize the state with a random value.</p> <h2 id="attaching-to-states"><a href="#attaching-to-states" class="header-anchor">#</a> Attaching to States</h2> <ul><li><a href="http://collective-soundworks.github.io/soundworks/server.SharedStateManagerServer.html#attach" target="_blank" rel="noopener noreferrer">server.SharedStateManagerServer#attach<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://collective-soundworks.github.io/soundworks/client.SharedStateManagerClient.html#attach" target="_blank" rel="noopener noreferrer">client.SharedStateManagerClient#attach<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Any node of the network (client or server) can attach to a state created by another node.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// or client-side</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">await</span> server<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>schemaName<span class="token punctuation">,</span> <span class="token punctuation">[</span>stateId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// or client-side</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>schemaName<span class="token punctuation">,</span> <span class="token punctuation">[</span>stateId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In our example, we want every player be informed of the current values of the <code>globalsState</code> created by the server, the player clients must thus <code>attach</code> to this state.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/clients/player/PlayerExperience.js (line 22-24)</span>
<span class="token keyword">const</span> globalsState <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token string">'globals'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'globalsState:'</span><span class="token punctuation">,</span> globalsState<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// &gt; globalsState: { master: 0, mute: false }</span>
</code></pre></div><p>Every player client is now attached to the <code>globals</code> state created by the server and will be notified if any update occur (more on that in <em>Subscribing to updates and updating states</em>).</p> <h2 id="observing-the-creation-of-states-on-the-network"><a href="#observing-the-creation-of-states-on-the-network" class="header-anchor">#</a> Observing the Creation of States on the Network</h2> <ul><li><a href="http://collective-soundworks.github.io/soundworks/server.SharedStateManagerServer.html#observe" target="_blank" rel="noopener noreferrer">server.SharedStateManagerServer#observe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://collective-soundworks.github.io/soundworks/client.SharedStateManagerClient.html#observe" target="_blank" rel="noopener noreferrer">client.SharedStateManagerClient#observe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://collective-soundworks.github.io/soundworks/client.SharedStateManagerClient.html#~observeCallback" target="_blank" rel="noopener noreferrer">client.SharedStateManagerClient~observeCallback<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>As states can be dynamically created by any node, we need a way to monitor the newly created state in the application (e.g. when a <code>player</code> client connect to the application, the <code>controller</code> client wants to be notified so it can attach to the newly created state and monitor or control it).</p> <p>This can be achived using the <code>observe</code> method :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// or client-side</span>
server<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>observeCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// or client-side</span>
client<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>observeCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In our example, the controller wants to track every <code>player</code> states created by <code>player</code> clients, to be able to monitor and control them remotely, it thus <code>observe</code> and attach to the state when notified:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/clients/controller/ControllerExperience (line 23)</span>

<span class="token comment">// create a list to store the player states</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>playerStates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">schemaName<span class="token punctuation">,</span> stateId<span class="token punctuation">,</span> nodeId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'arguments:'</span><span class="token punctuation">,</span> schemaName<span class="token punctuation">,</span> stateId<span class="token punctuation">,</span> nodeId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// the callback is called twice, for the global and player states</span>
  <span class="token comment">// &gt; arguments: 'globals' 0 -1</span>
  <span class="token comment">// &gt; arguments: 'player' 2 1</span>
  <span class="token keyword">switch</span><span class="token punctuation">(</span>schemaName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'player'</span><span class="token operator">:</span>
      <span class="token keyword">const</span> playerState <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span>stateManager<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>schemaName<span class="token punctuation">,</span> stateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'playerState:'</span><span class="token punctuation">,</span> playerState<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// &gt; playerState: {type: &quot;sine&quot;, frequency: 513}</span>

      <span class="token comment">// logic to do when the state is deleted</span>
      <span class="token comment">// (e.g. when the player disconnects)</span>
      playerState<span class="token punctuation">.</span><span class="token function">onDetach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// clean things</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>playerState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// stoare the player state into a list</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>playerStates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>playerState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="updating-values-and-subscribing-to-updates"><a href="#updating-values-and-subscribing-to-updates" class="header-anchor">#</a> Updating Values and Subscribing to Updates</h2> <p>Once we have a local instance of state (through <code>create</code> or <code>attach</code>), we need to be notified of any change that may occur and to be able to change its values.</p> <p>The <code>set</code> method allows for updating the values of a state</p> <div class="language-js extra-class"><pre class="language-js"><code>state<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>updates<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><a href="http://collective-soundworks.github.io/soundworks/common.SharedState.html#set" target="_blank" rel="noopener noreferrer">common.SharedState#set<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>In our example, the controller, once attached to a player state will update the <code>frequency</code> to a new random value every second (ok that probably does not make a lot of sens...):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/clients/controller/ControllerExperience (line 33)</span>
<span class="token keyword">const</span> intervalId <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> frequency <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">950</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> playerState<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> frequency <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><em>note: we wouldn't implement this kind of logic in a real world situation,  indeed here if we open 2 controllers each one will set a new value to the frequency every second</em></p> <p>The <code>subscribe</code> method allows to be notified when an update occur on the state:</p> <div class="language-js extra-class"><pre class="language-js"><code>state<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li><a href="http://collective-soundworks.github.io/soundworks/common.SharedState.html#subscribe" target="_blank" rel="noopener noreferrer">common.SharedState#subscribe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>In our example, the player can <code>subscribe</code> to the updates triggered by the controller and react accordingly. The callback is thus called every second (if we ignore the network latency):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/clients/controller/ControllerExperience (line 30)</span>
playerState<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">updates</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'updates:'</span><span class="token punctuation">,</span> updates<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// updates: { frequency: 288 }</span>
  <span class="token comment">// updates: { frequency: 965 }</span>
  <span class="token comment">// updates: { frequency: 540 }</span>
  <span class="token comment">// updates: { frequency: 120 }</span>
  <span class="token comment">// updates: { frequency: 678 }</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The same logic could be done with the <code>globals</code> state, at the difference that every player client would be notified of the update.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/collective-soundworks/collective-soundworks.github.io/edit/sources/docs/tutorials/state-manager.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/15/2021, 10:31:39 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ecosystem.html" class="prev">
        Ecosystem
      </a></span> <span class="next"><a href="/misc/setting-up-environment.html">
        Setting Up an Environment
      </a>
      →
    </span></p></div>  <section class="credits">
    {Sound Music Movement} Interaction Team - STMS-LAB
    <a href="https://www.ircam.fr/" class="ircam"></a> <a href="http://www.cnrs.fr/" class="cnrs"></a> <a href="http://www.sorbonne-universite.fr/" class="su"></a> <a href="https://www.culture.gouv.fr/" class="culture"></a></section></main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.03c7ac74.js" defer></script><script src="/assets/js/2.295789f1.js" defer></script><script src="/assets/js/3.020169b2.js" defer></script><script src="/assets/js/19.23b6d228.js" defer></script>
  </body>
</html>
